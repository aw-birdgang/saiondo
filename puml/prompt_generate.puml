@startuml
skinparam componentStyle rectangle

actor FlutterApp
package "Backend (NestJS)" {
  [API Controller]
  [RelationshipService]
  [LlmProxyService]
  [PrismaService]
}

package "LLM Server (FastAPI + LangChain)" {
  [LLMServer]
}

database "PostgreSQL" as DB

FlutterApp --> [API Controller] : 1. userInput 전송
[API Controller] --> [RelationshipService] : 2. 서비스 호출
[RelationshipService] --> [PrismaService] : 3. User/Partner 조회
[PrismaService] --> DB

[RelationshipService] --> [LlmProxyService] : 4. LLM 요청 생성
[LlmProxyService] --> [LLMServer] : 5. HTTP POST (messages, profile, summary, memory_schema)

[LLMServer] --> [LlmProxyService] : 6. JSON 응답 (reply, update, suggested_field)
[LlmProxyService] --> [RelationshipService] : 7. 응답 반환

[RelationshipService] --> [PrismaService] : 8. update 반영
[PrismaService] --> DB
[RelationshipService] --> [PrismaService] : 9. suggested_field 로그 저장
[PrismaService] --> DB

[RelationshipService] --> [API Controller] : 10. 최종 reply 반환
[API Controller] --> FlutterApp : 11. 사용자에게 응답 전달
@enduml
