# 🪙 SAIONDO 포인트-ERC20-NFT 연계 시스템 설계 및 연동 가이드

이 문서는 **SAIONDO** 서비스에서  
- **포인트 시스템**(앱 내 포인트)
- **ERC20 토큰**(블록체인 기반 커플 토큰)
- **NFT**(커플 인증/기념 NFT)  
이 세 가지가 어떻게 연계되어 동작하는지, 전체 구조와 흐름, API/스마트컨트랙트/DB/프론트 연동까지  
실제 코드/구조 기반으로 설명합니다.

---

## 📑 목차

1. [전체 아키텍처](#전체-아키텍처)
2. [주요 컴포넌트 및 역할](#주요-컴포넌트-및-역할)
3. [포인트 ↔ ERC20 ↔ NFT 연계 흐름](#포인트--erc20--nft-연계-흐름)
4. [DB/스마트컨트랙트/API/프론트 구조](#db스마트컨트랙트apifrnt-구조)
5. [실전 시나리오 예시](#실전-시나리오-예시)
6. [보안/운영/확장 팁](#보안운영확장-팁)
7. [참고/문서](#참고문서)

---

## 1. 전체 아키텍처

<p align="center">
  <img src="../assets/images/web3/point-erc20-nft-architecture.png" alt="포인트-ERC20-NFT 연계 아키텍처" width="900"/>
</p>

- **앱/웹(Flutter)**: 포인트 적립/사용, NFT 발급 UI
- **API 서버(NestJS)**: 포인트 적립/차감, 블록체인 연동, 인증/권한
- **LLM 서버(FastAPI)**: AI 분석/리포트, 포인트 보상 트리거
- **DB(PostgreSQL)**: 포인트/트랜잭션/유저/커플 정보 저장
- **Web3 서버/스크립트**: ERC20/NFT 스마트컨트랙트 연동, 트랜잭션 서명/전송
- **블록체인(Ethereum/Polygon)**: ERC20 토큰, NFT 발행/이관

---

## 2. 주요 컴포넌트 및 역할

| 컴포넌트 | 역할 |
|----------|------|
| **포인트 시스템** | 앱 내 활동(출석, 미션, 결제 등)으로 포인트 적립/차감, DB에 기록 |
| **ERC20 토큰** | 포인트를 온체인 토큰(커플 토큰)으로 전환, 블록체인 상 소유권/이력 관리 |
| **NFT** | 커플 인증, 기념일, 이벤트 등 특정 조건 달성 시 NFT 발급(온체인) |
| **API 서버** | 포인트-ERC20-NFT 변환/발급 로직, 인증/권한, 트랜잭션 관리 |
| **Web3 서버/스크립트** | 스마트컨트랙트 배포/호출, 트랜잭션 서명/전송, 이벤트 리스닝 |
| **DB** | 포인트/토큰/트랜잭션/유저/커플 상태 동기화, 이중 기록 |
| **프론트엔드** | 포인트 적립/전환, NFT 발급/조회 UI, Web3 지갑 연동 |

---

## 3. 포인트 ↔ ERC20 ↔ NFT 연계 흐름

### 3.1. 포인트 적립/차감

- **앱 내 활동**(출석, 미션, 결제 등) → API 서버 → DB에 포인트 적립/차감 기록

### 3.2. 포인트 → ERC20 전환

1. 유저가 "포인트 전환" 요청(앱/웹)
2. API 서버가 포인트 차감, 전환 가능 여부 체크
3. Web3 서버/스크립트가 ERC20 스마트컨트랙트에 `mint` 또는 `transfer` 트랜잭션 생성
4. 블록체인에 트랜잭션 전송, 성공 시 DB에 온체인 Tx 해시/상태 기록

### 3.3. ERC20 → 포인트 전환(역방향, 선택)

- 온체인 토큰을 앱 포인트로 환전(필요시)
- 블록체인 Tx 확인 후, API 서버가 포인트 적립

### 3.4. NFT 발급

1. 커플 인증/기념일/이벤트 등 조건 달성
2. API 서버가 NFT 발급 조건 체크
3. Web3 서버/스크립트가 NFT 스마트컨트랙트에 `mint` 트랜잭션 생성
4. 블록체인에 NFT 발급, 메타데이터(이미지/설명 등) 포함
5. DB에 NFT 소유/발급 이력 기록

---

## 4. DB/스마트컨트랙트/API/프론트 구조

### 4.1. DB 테이블 예시

- `user`: 유저 정보
- `couple`: 커플 정보
- `point_transaction`: 포인트 적립/차감 이력
- `erc20_transaction`: 온체인 토큰 전환/이관 이력
- `nft`: NFT 메타데이터, 소유 정보
- `nft_transaction`: NFT 발급/이관 이력

### 4.2. 스마트컨트랙트 구조

- **ERC20**: 커플 토큰(이름, 심볼, 소수점, mint/transfer/approve 등)
- **NFT(ERC721/1155)**: 커플 인증/기념 NFT, 메타데이터(이미지, 설명, 발급일 등)

### 4.3. API 서버 주요 엔드포인트 예시

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | `/point/earn` | 포인트 적립 |
| POST | `/point/use` | 포인트 차감 |
| POST | `/point/convert-to-erc20` | 포인트 → ERC20 전환 |
| POST | `/erc20/convert-to-point` | ERC20 → 포인트 전환(선택) |
| GET  | `/erc20/balance` | 온체인 토큰 잔액 조회 |
| POST | `/nft/mint` | NFT 발급(커플 인증/기념) |
| GET  | `/nft/list` | 내 NFT 목록 조회 |

### 4.4. 프론트엔드 연동

- 포인트 적립/전환, NFT 발급/조회 UI
- Web3 지갑(메타마스크 등) 연동, 온체인 Tx 서명/조회
- 온체인/오프체인 상태 동기화(잔액, NFT 등)

---

## 5. 실전 시나리오 예시

### 5.1. 커플 미션 달성 → 포인트 적립 → 커플 토큰 전환 → NFT 발급

1. 커플 미션 달성 → 포인트 100점 적립
2. 포인트 100점 → ERC20 커플 토큰 100개로 전환
3. 커플 100일 달성 → 기념 NFT 발급(온체인)
4. 앱에서 내 토큰/NFT 실시간 조회, 거래/이관 가능

### 5.2. 결제/이벤트 → 포인트/토큰/NFT 보상

- 결제/이벤트 참여 시 포인트 적립, 토큰/한정판 NFT 보상 등 다양한 연계 가능

---

## 6. 보안/운영/확장 팁

- **포인트-온체인 동기화**: 트랜잭션/상태를 DB와 블록체인 모두에 기록, 이중 체크
- **트랜잭션 서명/전송**: 민감 연산은 서버에서 서명, 유저 지갑 연동 시 클라이언트 서명
- **이중 지급/중복 방지**: Tx 해시, 상태값, DB 트랜잭션 등으로 중복 지급 방지
- **NFT 메타데이터**: IPFS 등 분산 저장소 활용 권장
- **확장성**: ERC20/NFT 컨트랙트 업그레이드, 멀티체인 지원 고려
- **비용/가스**: Polygon 등 저가스 체인 활용, 수수료 정책 설계
- **보안**: 컨트랙트 감사, API 인증/권한, 민감 정보 암호화

---

## 7. 참고/문서

- [ERC20 표준](https://eips.ethereum.org/EIPS/eip-20)
- [ERC721 표준](https://eips.ethereum.org/EIPS/eip-721)
- [OpenZeppelin Contracts](https://docs.openzeppelin.com/contracts/)
- [Web3.js](https://web3js.readthedocs.io/)
- [Ethers.js](https://docs.ethers.org/)
- [SAIONDO Web3/블록체인 문서](../web3/README.md)
- [SAIONDO API 서버 문서](../backend/api/README.md)
- [SAIONDO Flutter 앱 문서](../frontend/app/README.md)

---